<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0e2a35" />
  <title>Golfcourse Multiplayer Scorecard</title>
  <style>
  :root{
    --bg:#0e2a35; --ink:#eaf8ff; --muted:#9fc0cf;
    --panel:#133745; --panel2:#164554; --line:#092331; --btn:#1b6177; --btn2:#154a5a;
    --touch:56px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--ink)}
  .app{max-width:1100px;margin:0 auto;padding:12px;padding-bottom:calc(12px + env(safe-area-inset-bottom))}
  .header{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{background:#e6f5fb;color:#0b2430;border-radius:.8rem;padding:.55rem .7rem;font-weight:800}
  .badge.dim{background:#cfeef9}
  .spacer{flex:1}
  .layout{display:grid;grid-template-columns:1fr;gap:12px;margin-top:8px}
  .card{background:var(--panel);border:2px solid var(--line);border-radius:12px;padding:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .tile{background:var(--panel2);border-radius:10px;padding:12px;text-align:center;font-weight:800}
  .tile.big{font-size:60px;line-height:1.05}
  .pill{background:#0c2f3a;border:1px solid var(--line);border-radius:8px;padding:10px;color:var(--ink);width:100%}
  .pill.biginput{font-size:1.2rem;font-weight:900}
  .muted{color:var(--muted);font-size:.9rem}
  .btn{display:inline-flex;align-items:center;justify-content:center;background:var(--btn);border:2px solid var(--line);border-radius:12px;min-height:var(--touch);font-size:1.1rem;font-weight:800;color:var(--ink);padding:.6rem .8rem;cursor:pointer;user-select:none}
  .btn.alt{background:var(--btn2)}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .sticker{position:relative;display:flex;align-items:center;justify-content:center;height:140px;background:#103947;border-radius:12px;overflow:hidden}
  .sticker img{max-height:130px;max-width:100%}
  .loggrid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
  .loggrid .cell{background:#0c2f3a;border:1px solid var(--line);border-radius:8px;padding:8px;text-align:center;font-weight:900}
  .tabs.bottom{position:sticky;bottom:0;z-index:40;display:flex;gap:8px;background:linear-gradient(180deg,transparent,rgba(10,30,38,.9) 40%);padding:8px;margin:12px -12px -12px -12px}
  #confetti{position:fixed;inset:0;pointer-events:none}
  .small{display:block;font-size:.9rem;font-weight:700;opacity:.95;margin-top:6px}
  .scoreGrid{display:grid;grid-template-columns:1fr 1.2fr;gap:10px}
  .view{display:none}.view.active{display:block}
  @media (max-width:900px){ .scoreGrid{grid-template-columns:1fr} }

  /* --- GOLF COURSE view helpers --- */
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border:1px solid var(--line);padding:6px;text-align:center}
  .table th{background:#0c2f3a}
  .table input{width:100%;background:#0b2f3a;border:1px solid #0a2732;color:var(--ink);border-radius:6px;padding:6px}
  .inline{display:flex;gap:8px;flex-wrap:wrap}
  .tag{background:#0c2f3a;border:1px solid var(--line);padding:.35rem .55rem;border-radius:.7rem;font-weight:800}
  .list{display:grid;grid-template-columns:1fr;gap:8px}
  .item{display:flex;align-items:center;justify-content:space-between;background:#0c2f3a;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  .sm{font-size:.9rem}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div id="gameTitle" class="badge">Golf Course</div>
      <div id="holeHeader" class="badge dim">H01 ‚Ä¢ Par ? ‚Ä¢ 000m</div>
      <div class="spacer"></div>
    </div>

    <div class="layout">
      <div class="card">
        <!-- ===== SCORE VIEW ===== -->
        <div id="view-score" class="view active">
          <div class="row" style="margin-bottom:8px">
            <div>
              <div class="muted">Speler</div>
              <input id="playerNameInline" class="pill biginput" placeholder="Jouw naam">
            </div>
            <div>
              <div class="muted">Handicap</div>
              <input id="playerHcpInline" class="pill biginput" type="number" step="1" value="0">
            </div>
          </div>

          <div class="row">
            <div id="holeCode" class="tile">
              H01
              <span class="small muted">Par <span id="parUnder">?</span></span>
              <span class="small muted">Tijd <span id="timeUnder">0:00</span></span>
            </div>
            <div id="holeDist" class="tile">000</div>
          </div>

          <div class="scoreGrid" style="margin-top:10px">
            <div>
              <div class="tile" style="display:flex;align-items:center;justify-content:center;font-size:42px;font-weight:900;margin-bottom:8px">
                Slag <span id="strokeAbove" style="margin-left:6px">0</span>
              </div>
              <div class="sticker" id="stickerBox">
                <img id="stickerImg" src="" alt="Beloning" style="display:none">
              </div>
            </div>
            <div>
              <div class="grid5" style="margin-bottom:8px">
                <button class="btn" data-club="D">D</button>
                <button class="btn" data-club="3">3</button>
                <button class="btn" data-club="4">4</button>
                <button class="btn" data-club="5">5</button>
                <button class="btn" data-club="6">6</button>
                <button class="btn" data-club="7">7</button>
                <button class="btn" data-club="8">8</button>
                <button class="btn" data-club="9">9</button>
                <button class="btn" data-club="W">W</button>
                <button class="btn" data-club="P">P</button>
              </div>
              <!-- rij 1 -->
              <div class="grid4">
                <button class="btn alt" data-special="ball"   aria-label="nieuwe bal">‚ö™</button>
                <button class="btn alt" data-special="bunker" aria-label="bunker">üèúÔ∏è</button>
                <button class="btn alt" data-special="water"  aria-label="water">üíß</button>
                <button class="btn alt" data-special="mulligan" aria-label="mulligan">üéÅ</button>
              </div>
              <!-- rij 2 -->
              <div class="grid4" style="margin-top:8px">
                <button class="btn alt" data-special="oob" aria-label="out of bounds">üå≤</button>
                <button class="btn alt" data-special="star" aria-label="highlight shot">‚≠ê</button>
                <button class="btn alt" data-special="resign" aria-label="opgegeven">üî¥</button>
                <button id="flagBtn" class="btn alt" aria-label="hole klaar" title="Hole klaar">
                  <svg width="22" height="22" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M5 3v18" stroke="#8fb3ff" stroke-width="2"/>
                    <path d="M6 4h11l-3 3 3 3H6z" fill="#3b82f6"/>
                    <circle cx="6" cy="20" r="2" fill="#0b2740"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <div class="muted" style="margin-bottom:6px">Slaglog</div>
              <div id="strokeLog" class="loggrid"></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px">Totaal hole</div>
              <div class="pill" style="font-size:22px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
                <span id="holeTotal">0</span>
                <span id="overPar" style="color:#9fb0ba;font-weight:800">¬±0</span>
              </div>
              <div id="deltaTxt" class="muted">t.o.v. Par: 0</div>
              <div class="row" style="margin-top:8px">
                <div class="pill">Putts: <span id="puts">0</span></div>
                <div class="pill">Ball: <span id="penBall">0</span></div>
              </div>
              <div class="row" style="margin-top:6px">
                <div class="pill">Water: <span id="penWater">0</span></div>
                <div class="pill">Bunker: <span id="penBunker">0</span></div>
              </div>
              <div class="row" style="margin-top:6px">
                <button id="prevHole" class="btn">Vorige</button>
                <button id="nextHole" class="btn">Volgende</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== GOLF COURSE (beheer) ===== -->
        <div id="view-settings" class="view">
          <h3 style="margin:6px 0 10px">Golf Course ‚Ä¢ Wedstrijd & Baan</h3>

          <!-- Wedstrijd meta -->
          <div class="tile" style="text-align:left;margin-bottom:10px">
            <div class="inline">
              <div style="flex:1;min-width:220px">
                <div class="muted">Wedstrijdnaam</div>
                <input id="gcGameName" class="pill" placeholder="Bijv. Zomerbokaal">
              </div>
              <div style="width:150px">
                <div class="muted">Hole-range</div>
                <select id="gcHoleRange" class="pill">
                  <option value="1-18">1‚Äì18</option>
                  <option value="1-9">1‚Äì9</option>
                  <option value="10-18">10‚Äì18</option>
                </select>
              </div>
              <div style="width:160px">
                <div class="muted">TeeTime (default)</div>
                <input id="gcTeeTime" class="pill" type="time">
              </div>
              <div style="width:140px">
                <div class="muted">Flight (default)</div>
                <input id="gcFlight" class="pill" placeholder="A / 1 / ‚Ä¶">
              </div>
            </div>
            <div class="inline" style="margin-top:8px">
              <div style="flex:1;min-width:220px">
                <div class="muted">Golfbaan</div>
                <input id="gcCourseName" class="pill" placeholder="Course naam">
              </div>
              <div style="flex:1;min-width:180px">
                <div class="muted">Plaats</div>
                <input id="gcCourseCity" class="pill" placeholder="Plaats">
              </div>
              <button id="gcSaveMeta" class="btn">Opslaan wedstrijd + baan</button>
            </div>
            <div class="muted sm" style="margin-top:6px">Wordt opgeslagen in <span class="tag">games/{gameId}</span>.</div>
          </div>

          <!-- Holes editor -->
          <div class="card" style="border-color:#0a2b39">
            <div class="inline" style="align-items:center;justify-content:space-between;margin-bottom:6px">
              <div style="font-weight:800">Holes (Par ‚Ä¢ Afstand ‚Ä¢ Naam)</div>
              <div class="inline">
                <button id="gcFillPar4" class="btn alt sm" style="min-height:auto">Par4 ‚Ä¢ 300m</button>
                <button id="gcSaveHoles" class="btn sm" style="min-height:auto">Holes opslaan</button>
              </div>
            </div>
            <table class="table" id="holesTable">
              <thead><tr><th>#</th><th>Par</th><th>m</th><th>Naam (optioneel)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Players / Flights -->
          <div class="card" style="border-color:#0a2b39;margin-top:10px">
            <div style="font-weight:800;margin-bottom:8px">Spelers & Flights</div>

            <div class="inline">
              <input id="plName" class="pill" placeholder="Naam speler" style="flex:2;min-width:180px">
              <input id="plHcp" class="pill" type="number" step="1" value="0" style="width:110px" placeholder="HCP">
              <input id="plFlight" class="pill" placeholder="Flight" style="width:120px">
              <input id="plTee" class="pill" type="time" style="width:150px" placeholder="TeeTime">
              <button id="addPlayerBtn" class="btn">Speler toevoegen</button>
            </div>
            <div class="muted sm" style="margin-top:6px">Toegevoegd aan <span class="tag">games/{gameId}/players</span>. Je eigen inline naam/hcp wordt gesynct met je eigen spelerskaart.</div>

            <div id="playersList" class="list" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- ===== LEADERBOARD ===== -->
        <div id="view-leader" class="view">
          <h3>Leaderboard</h3>
          <div id="leaderFull" class="card"></div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="endRoundBtn" class="btn">Einde ronde ‚Ä¢ Vier winnaar</button>
          </div>
        </div>
      </div>

      <!-- bottom tabs -->
      <div class="tabs bottom" role="navigation" aria-label="Tabs">
        <button class="tabbtn active" data-tab="score">SCORE</button>
        <button class="tabbtn" data-tab="leader">LEADERBOARD</button>
        <button class="tabbtn" data-tab="settings">GOLF COURSE</button>
      </div>
    </div>
  </div>

  <canvas id="confetti"></canvas>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, collection, addDoc, getDocs, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  /* Firebase config (jouw project) */
  const firebaseConfig = {
    apiKey: "AIzaSyBmLsJ5l3_733r3TMSMcQ3XTB7B5-lStTs",
    authDomain: "golfcourse-mp-scorecard.firebaseapp.com",
    projectId: "golfcourse-mp-scorecard",
    storageBucket: "golfcourse-mp-scorecard.appspot.com",
    messagingSenderId: "758687332564",
    appId: "1:758687332564:web:7db1d2f2f27c3282f2e341"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* ===== SIMPLE TABS ===== */
  const views = {
    score: document.getElementById('view-score'),
    leader: document.getElementById('view-leader'),
    settings: document.getElementById('view-settings')
  };
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.onclick=()=>{
      document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      Object.values(views).forEach(v=>v.classList.remove('active'));
      views[btn.dataset.tab].classList.add('active');
    };
  });

  /* ===== STATE ===== */
  let uid=null;
  let gameId = new URLSearchParams(location.search).get('game') || null;
  let currentHole = 1;
  let holeRange = '1-18';
  let holesData = {}; // {1:{par,distance,name},...}
  let me = null;      // {name,handicap,holes:{}}
  let unsubPlayers = null;

  const el = id => document.getElementById(id);
  const rangeBounds = ()=> holeRange==='1-9' ? [1,9] : holeRange==='10-18' ? [10,18] : [1,18];

  /* ===== AUTH ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ await signInAnonymously(auth); return; }
    uid=user.uid;
    if(gameId) subscribeGame(gameId);
  });

  /* ===== HELPERS ===== */
  function blankHoles(){ const o={}; for(let i=1;i<=18;i++) o[i]={par:4,distance:300,name:''}; return o; }
  function mmss(sec){ const m=Math.floor(sec/60); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }

  function defaultHole(){
    return { strokes:[], putts:0, penalties:{ball:0,water:0,bunker:0,oob:0}, total:0, sticker:null,
             startTs:null, endTs:null, duration:0, mulliganUsed:false, resigned:false };
  }

  function strokeState(){
    const all=(me&&me.holes)||{}; const key=String(currentHole);
    return JSON.parse(JSON.stringify(all[key] || defaultHole()));
  }

  async function persistHole(hstate){
    if(!gameId||!uid) return;
    me = me || {}; me.holes = me.holes || {};
    me.holes[String(currentHole)] = hstate;
    await setDoc(doc(db,'games',gameId,'scores',uid), {holes:me.holes},{merge:true});
  }

  function updateTimeUI(h){
    const tEl = document.getElementById('timeUnder');
    if(!tEl) return;
    let sec=0;
    if(h.endTs){ sec = h.duration||0; }
    else if(h.startTs){ sec = Math.floor((Date.now()-h.startTs)/1000); }
    tEl.textContent = mmss(sec);
  }

  function updateScoreUI(){
    const h = strokeState();
    el('puts').textContent      = h.putts||0;
    el('penBall').textContent   = h.penalties?.ball||0;
    el('penWater').textContent  = h.penalties?.water||0;
    el('penBunker').textContent = h.penalties?.bunker||0;

    const log = el('strokeLog');
    const BLUE_FLAG_SVG = '<svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M5 3v18" stroke="#8fb3ff" stroke-width="2"/><path d="M6 4h11l-3 3 3 3H6z" fill="#3b82f6"/></svg>';
    log.innerHTML = (h.strokes||[])
      .slice(-16)
      .map(s=> s==='‚õ≥' ? `<div class="cell">${BLUE_FLAG_SVG}</div>` : `<div class="cell">${s}</div>`)
      .join('');

    const par = holesData[currentHole]?.par ?? 0;
    el('holeTotal').textContent = h.total||0;
    el('overPar').textContent   = ((h.total||0)-par)>0?`+${(h.total||0)-par}`:`${(h.total||0)-par}`;
    el('deltaTxt').textContent  = `t.o.v. Par: ${(h.total||0)-par}`;
    const sa = document.getElementById('strokeAbove'); if(sa) sa.textContent=h.total||0;

    // tijd
    updateTimeUI(h);

    // sticker zichtbaar houden
    const img = document.getElementById('stickerImg');
    if(h.sticker){ img.src = stickerImg(h.sticker)||''; img.style.display='block'; } else { img.src=''; img.style.display='none'; }
  }

  function updateHeader(){
    const d=holesData[currentHole]||{par:'?',distance:'000'};
    el('holeHeader').textContent = `H${String(currentHole).padStart(2,'0')} ‚Ä¢ Par ${d.par} ‚Ä¢ ${d.distance}m`;
    el('holeCode').innerHTML = `H${String(currentHole).padStart(2,'0')}
      <span class="small muted">Par <span id="parUnder">${d.par??'?'}<\/span><\/span>
      <span class="small muted">Tijd <span id="timeUnder">0:00<\/span><\/span>`;
    el('holeDist').textContent = d.distance;
  }

  /* ===== SUBSCRIPTIONS ===== */
  async function subscribeGame(id){
    // game meta
    onSnapshot(doc(db,'games',id),(snap)=>{
      if(!snap.exists()) return;
      const g=snap.data();
      holeRange = g.holeRange || '1-18';
      holesData = g.holes || blankHoles();

      // header badge
      const nameBadge = g.name || 'Golf Course';
      const flightBadge = g.defaultFlight ? ` ‚Ä¢ Flight ${g.defaultFlight}` : (g.flight ? ` ‚Ä¢ Flight ${g.flight}` : '');
      el('gameTitle').textContent = `${nameBadge}${flightBadge}`;

      updateHeader();
      updateScoreUI();

      // sync GC form
      el('gcGameName').value = g.name || '';
      el('gcHoleRange').value = g.holeRange || '1-18';
      el('gcTeeTime').value = g.defaultTeeTime || g.teeTime || '';
      el('gcFlight').value = g.defaultFlight || g.flight || '';
      el('gcCourseName').value = g.course?.name || '';
      el('gcCourseCity').value = g.course?.city || '';

      buildHolesTable(holesData);
    });

    // scores (mijn doc)
    onSnapshot(doc(db,'games',id,'scores',uid),(snap)=>{
      if(!snap.exists()) return;
      me = me || {}; me.holes = snap.data().holes||{};
      updateScoreUI();
    });

    // spelersnaam/hcp inline sync
    onSnapshot(doc(db,'games',id,'players',uid),(snap)=>{
      if(snap.exists()){
        const p=snap.data();
        document.getElementById('playerNameInline').value = p.name || '';
        document.getElementById('playerHcpInline').value  = p.handicap ?? 0;
      }
    });

    // spelerslijst
    listenPlayers();
  }

  function listenPlayers(){
    if(!gameId) return;
    if(unsubPlayers) unsubPlayers(); // cleanup
    const qPlayers = query(collection(db,'games',gameId,'players'));
    unsubPlayers = onSnapshot(qPlayers, (snap)=>{
      const wrap = el('playersList');
      wrap.innerHTML = '';
      snap.forEach(d=>{
        const p=d.data();
        const line = document.createElement('div');
        line.className='item';
        line.innerHTML = `
          <div>
            <div style="font-weight:800">${p.name || '‚Äî'} <span class="tag sm">HCP ${p.handicap ?? 0}</span></div>
            <div class="muted sm">Flight: ${p.flight || '-'} ‚Ä¢ Tee: ${p.teeTime || '-'}</div>
          </div>
          <div class="inline">
            <button class="btn alt sm" style="min-height:auto" data-edit="${d.id}">Edit</button>
            <button class="btn sm" style="min-height:auto;background:#7a2030" data-del="${d.id}">Verwijder</button>
          </div>
        `;
        wrap.appendChild(line);
      });

      // bind delete/edit
      wrap.querySelectorAll('[data-del]').forEach(b=>{
        b.onclick = async ()=>{
          await deleteDoc(doc(db,'games',gameId,'players', b.dataset.del));
        };
      });
      wrap.querySelectorAll('[data-edit]').forEach(b=>{
        b.onclick = async ()=>{
          const ref = doc(db,'games',gameId,'players', b.dataset.edit);
          const snap = await getDoc(ref); if(!snap.exists()) return;
          const p=snap.data();
          el('plName').value = p.name || '';
          el('plHcp').value = p.handicap ?? 0;
          el('plFlight').value = p.flight || '';
          el('plTee').value = p.teeTime || '';
          el('addPlayerBtn').textContent = 'Opslaan wijzigingen';
          el('addPlayerBtn').dataset.editing = b.dataset.edit;
        };
      });
    });
  }

  /* ===== STICKERS ===== */
  function stickerFor(total,par,extra){
    const d=total-par;
    if(total===8) return 'snowman';
    if(extra.putts>=3) return 'three-putt';
    if(d<=-3) return 'albatross';
    if(d===-2) return 'eagle';
    if(d===-1) return 'birdie';
    if(d===0)  return 'par';
    if(d===1)  return 'bogey';
    if(d===2)  return 'double-bogey';
    if(d>=3)   return 'triple-bogey';
    return null;
  }
  const stickerImg = k=>({
    'albatross':'assets/albatross.png',
    'eagle':'assets/eagle.png',
    'birdie':'assets/birdie.png',
    'par':'assets/par.png',
    'bogey':'assets/bogey.png',
    'double-bogey':'assets/double-bogey.png',
    'triple-bogey':'assets/triple-bogey.png',
    'snowman':'assets/snowman.png',
    'three-putt':'assets/three-putt.png',
    'breakfast':'assets/breakfast.png',
    'mulligan':'assets/mulligan.png'
  })[k];

  function confettiRain(ms=5000){
    const c=document.getElementById('confetti'),ctx=c.getContext('2d');
    let W=c.width=innerWidth,H=c.height=innerHeight;
    let parts=Array.from({length:180},()=>({x:Math.random()*W,y:-20-Math.random()*H,r:2+Math.random()*4,vy:2+Math.random()*3,vx:(Math.random()-.5)*1.2}));
    const end=performance.now()+ms;
    (function tick(){
      ctx.clearRect(0,0,W,H);
      parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.y>H+10){ p.y=-10; p.x=Math.random()*W; }
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle=`hsl(${Math.random()*360},100%,65%)`; ctx.fill(); });
      if(performance.now()<end) requestAnimationFrame(tick); else ctx.clearRect(0,0,W,H);
    })();
    addEventListener('resize',()=>{W=c.width=innerWidth; H=c.height=innerHeight;},{once:true});
  }
  function bigSticker(text,key){
    const src = stickerImg(key); if(!src) return;
    const overlay=document.createElement('div');
    overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(0,0,0,.6)';
    overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex=10000;
    const box=document.createElement('div');
    box.style.background='rgba(8,26,32,.95)'; box.style.border='3px solid #0a2732'; box.style.borderRadius='16px';
    box.style.padding='16px 20px'; box.style.display='flex'; box.style.flexDirection='column'; box.style.alignItems='center'; box.style.gap='10px';
    box.innerHTML=`<img src="${src}" style="height:120px"/><div style="font-size:24px;font-weight:900">${text}</div><div class="muted" style="font-size:16px">${key}</div>`;
    overlay.appendChild(box); document.body.appendChild(overlay);
    setTimeout(()=>overlay.remove(), 4000);
  }

  // 30s Royal confetti met emoji + slingers
  function royalConfetti(durationMs=30000){
    const c = document.getElementById('confetti');
    const ctx = c.getContext('2d');
    let W = c.width = innerWidth, H = c.height = innerHeight;

    const EMOJI = ['üëë','‚≠ê','üéâ','üéä'];
    const pieces = [];

    for(let i=0;i<220;i++){
      pieces.push({
        type:'emoji',
        char: EMOJI[Math.floor(Math.random()*EMOJI.length)],
        x: Math.random()*W,
        y: -20 - Math.random()*H,
        vy: 1.5 + Math.random()*2.5,
        vx: (Math.random()-.5)*1.2,
        rot: Math.random()*Math.PI*2,
        rSpeed: (Math.random()-.5)*0.04,
        size: 18 + Math.random()*16
      });
    }
    for(let i=0;i<60;i++){
      pieces.push({
        type:'streamer',
        x: Math.random()*W,
        y: -40 - Math.random()*H,
        vy: 1.2 + Math.random()*1.8,
        vx: (Math.random()-.5)*0.6,
        w: 6+Math.random()*10,
        h: 60+Math.random()*120,
        hue: Math.floor(Math.random()*360),
        alpha: .8
      });
    }

    const end = performance.now()+durationMs;
    function step(){
      ctx.clearRect(0,0,W,H);
      for(const p of pieces){
        p.x += p.vx; p.y += p.vy;

        if(p.type==='emoji'){
          p.rot += p.rSpeed;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.font = `${p.size}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
          ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText(p.char, 0, 0);
          ctx.restore();
        }else{
          ctx.save();
          ctx.globalAlpha = p.alpha;
          ctx.fillStyle = `hsl(${p.hue}, 85%, 60%)`;
          ctx.translate(p.x, p.y);
          ctx.rotate((p.x+p.y)/200);
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.restore();
        }

        if(p.y > H + 50){ p.y = -50; p.x = Math.random()*W; }
      }
      if(performance.now()<end){ requestAnimationFrame(step); } else { ctx.clearRect(0,0,W,H); }
    }
    step();
    addEventListener('resize', ()=>{ W=c.width=innerWidth; H=c.height=innerHeight; }, {once:true});
  }

  function bigWinnerOverlay(name){
    const overlay = document.createElement('div');
    overlay.style.position='fixed';
    overlay.style.inset='0';
    overlay.style.background='rgba(0,0,0,.55)';
    overlay.style.backdropFilter='blur(2px)';
    overlay.style.display='flex';
    overlay.style.flexDirection='column';
    overlay.style.alignItems='center';
    overlay.style.justifyContent='center';
    overlay.style.gap='12px';
    overlay.style.zIndex=10050;

    const box = document.createElement('div');
    box.style.background='rgba(8,26,32,.97)';
    box.style.border='3px solid #0a2732';
    box.style.borderRadius='18px';
    box.style.padding='18px 22px';
    box.style.textAlign='center';
    box.style.maxWidth='90vw';

    box.innerHTML = `
      <div style="font-size:54px;line-height:1.1">üëë‚≠êüéâüéä</div>
      <div style="font-size:26px;font-weight:900;margin-top:6px">Gefeliciteerd ${name}!</div>
      <div class="muted" style="font-size:18px;margin-top:4px">Je bent de koning van deze ronde!</div>
      <div style="font-size:18px;margin-top:8px">Je hebt wel een heerlijk koud biertje verdiend!</div>
      <div style="font-size:44px;margin-top:8px">üçª</div>
    `;
    overlay.appendChild(box);
    document.body.appendChild(overlay);
    setTimeout(()=> overlay.remove(), 8000);
  }

  /* ===== SCORE INTERACTIES ===== */
  function addStroke(kind){
    const s = strokeState();
    const countable=['D','W','P','3','4','5','6','7','8','9'];

    if(kind==='P'){ s.putts=(s.putts||0)+1; }

    if(countable.includes(kind)){
      if(!s.startTs) s.startTs = Date.now();
      s.strokes.push(kind); s.total=(s.total||0)+1;
    }

    if(kind==='ball'){  s.penalties.ball=(s.penalties.ball||0)+1;  s.strokes.push('‚ö™'); s.total=(s.total||0)+1; if(!s.startTs) s.startTs=Date.now(); }
    if(kind==='water'){ s.penalties.water=(s.penalties.water||0)+1; s.strokes.push('üíß'); s.total=(s.total||0)+1; if(!s.startTs) s.startTs=Date.now(); }
    if(kind==='bunker'){ s.penalties.bunker=(s.penalties.bunker||0)+1; s.strokes.push('üèúÔ∏è'); }

    if(kind==='oob'){ s.penalties.oob=(s.penalties.oob||0)+1; s.strokes.push('üå≤'); s.total=(s.total||0)+1; if(!s.startTs) s.startTs=Date.now(); }
    if(kind==='star'){ s.strokes.push('‚≠ê'); }
    if(kind==='resign'){ s.resigned=true; s.strokes.push('üî¥'); }

    if(kind==='mulligan'){
      if(s.mulliganUsed){ alert('Mulligan al gebruikt op deze hole.'); return; }
      const reversible=['D','W','P','3','4','5','6','7','8','9','‚ö™','üíß'];
      if(s.strokes.length){
        const last = s.strokes[s.strokes.length-1];
        if(reversible.includes(last)){
          s.strokes.pop();
          s.total = Math.max(0,(s.total||0)-1);
        }else{
          for(let i=s.strokes.length-1;i>=0;i--){
            if(reversible.includes(s.strokes[i])){ s.strokes.splice(i,1); s.total=Math.max(0,(s.total||0)-1); break; }
          }
        }
      }
      s.mulliganUsed=true; s.strokes.push('üéÅ');
    }

    me = me || {}; me.holes = me.holes || {}; me.holes[String(currentHole)] = s;
    updateScoreUI();
    persistHole(s);
  }

  document.querySelectorAll('[data-club]').forEach(b=>b.onclick=()=>addStroke(b.dataset.club));
  document.querySelectorAll('[data-special]').forEach(b=>b.onclick=()=>addStroke(b.dataset.special));

  document.getElementById('flagBtn').onclick = async ()=>{
    const s = strokeState();
    if(!s.strokes.includes('‚õ≥')) s.strokes.push('‚õ≥');
    if(!s.startTs) s.startTs = Date.now();
    if(!s.endTs){ s.endTs = Date.now(); s.duration = Math.floor((s.endTs - s.startTs)/1000); }

    const par = holesData[currentHole]?.par ?? 0;
    const key = stickerFor(s.total, par, s);
    if(key){
      s.sticker=key;
      const img=document.getElementById('stickerImg'); const src=stickerImg(key); if(src){ img.src=src; img.style.display='block'; }
      if(key==='birdie' || key==='eagle' || key==='par') confettiRain(5000);
      const playerDoc = await getDoc(doc(db,'games',gameId,'players',uid));
      const playerName = playerDoc.exists()? (playerDoc.data().name||'Player') : 'Player';
      await addDoc(collection(db,'games',gameId,'events'), {type:'sticker', hole:currentHole, playerName, sticker:key, at:serverTimestamp()});
      bigSticker(`${playerName} ‚Ä¢ H${String(currentHole).padStart(2,'0')}`, key);
    }

    me = me || {}; me.holes = me.holes || {}; me.holes[String(currentHole)] = s;
    await persistHole(s);
    updateScoreUI();

    const [sH,eH]=rangeBounds();
    currentHole = currentHole<eH ? currentHole+1 : sH;
    updateHeader(); updateScoreUI();
  };

  document.getElementById('prevHole').onclick = ()=>{ const[sH,eH]=rangeBounds(); currentHole = currentHole>sH ? currentHole-1 : eH; updateHeader(); updateScoreUI(); };
  document.getElementById('nextHole').onclick = ()=>{ const[sH,eH]=rangeBounds(); currentHole = currentHole<eH ? currentHole+1 : sH; updateHeader(); updateScoreUI(); };

  /* ===== LEADERBOARD / WINNER ===== */
  function grossForRange(holesObj, start, end){
    let gross = 0;
    for(let h=start; h<=end; h++){ gross += holesObj?.[String(h)]?.total || 0; }
    return gross;
  }

  async function celebrateWinner(){
    if(!gameId) return;

    const gSnap = await getDoc(doc(db,'games',gameId));
    const holeRangeVal = gSnap.exists() ? (gSnap.data().holeRange || '1-18') : '1-18';
    const [start,end] = holeRangeVal==='10-18' ? [10,18] : holeRangeVal==='1-9' ? [1,9] : [1,18];

    const playersSnap = await getDocs(collection(db,'games',gameId,'players'));
    const players = {};
    playersSnap.forEach(d=> players[d.id] = d.data());

    const scoresSnap = await getDocs(collection(db,'games',gameId,'scores'));

    let winnerId = null;
    let bestNet = Infinity;

    scoresSnap.forEach(sdoc=>{
      const uid_ = sdoc.id;
      const sdata = sdoc.data() || {};
      const gross = grossForRange(sdata.holes||{}, start, end);
      const hcp = players[uid_]?.handicap || 0;
      const net = gross - hcp;
      if(net < bestNet){ bestNet = net; winnerId = uid_; }
    });

    const winnerName = winnerId ? (players[winnerId]?.name || 'Winnaar') : 'Winnaar';

    royalConfetti(30000);
    bigWinnerOverlay(winnerName);
  }

  const endBtn = document.getElementById('endRoundBtn');
  if(endBtn){ endBtn.onclick = celebrateWinner; }

  /* ===== GOLF COURSE: UI LOGICA ===== */

  // Build holes table rows 1..18
  function buildHolesTable(data){
    const tbody = document.querySelector('#holesTable tbody');
    tbody.innerHTML = '';
    for(let i=1;i<=18;i++){
      const d = data?.[i] || {par:4,distance:300,name:''};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>H${String(i).padStart(2,'0')}</td>
        <td><input type="number" min="3" max="6" step="1" value="${d.par ?? 4}" data-hole="${i}" data-field="par"></td>
        <td><input type="number" min="60" max="650" step="1" value="${d.distance ?? 300}" data-hole="${i}" data-field="distance"></td>
        <td><input type="text" value="${d.name ?? ''}" placeholder="bijv. Dogleg Left" data-hole="${i}" data-field="name"></td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Save meta (wedstrijd + course)
  el('gcSaveMeta').onclick = async ()=>{
    if(!gameId){ alert('Geen gameId in de URL (?game=...)'); return; }
    const payload = {
      name: el('gcGameName').value.trim() || null,
      holeRange: el('gcHoleRange').value || '1-18',
      defaultTeeTime: el('gcTeeTime').value || null,
      defaultFlight: el('gcFlight').value?.trim() || null,
      course: {
        name: el('gcCourseName').value.trim() || null,
        city: el('gcCourseCity').value.trim() || null
      },
      updatedAt: serverTimestamp()
    };
    await setDoc(doc(db,'games',gameId), payload, {merge:true});
    alert('Wedstrijd en baan opgeslagen.');
  };

  // Fill defaults Par4 / 300m
  el('gcFillPar4').onclick = ()=>{
    buildHolesTable(blankHoles());
  };

  // Save holes
  el('gcSaveHoles').onclick = async ()=>{
    if(!gameId){ alert('Geen gameId in de URL (?game=...)'); return; }
    const inputs = Array.from(document.querySelectorAll('#holesTable [data-hole]'));
    const holes = {};
    for(const input of inputs){
      const h = Number(input.dataset.hole);
      holes[h] = holes[h] || {par:4,distance:300,name:''};
      const field = input.dataset.field;
      let val = input.value;
      if(field!=='name'){ val = Number(val||0); }
      holes[h][field] = val;
    }
    await setDoc(doc(db,'games',gameId), {holes}, {merge:true});
    alert('Holes opgeslagen.');
  };

  // Add / Edit player
  el('addPlayerBtn').onclick = async ()=>{
    if(!gameId){ alert('Geen gameId in de URL (?game=...)'); return; }
    const name = el('plName').value.trim();
    const handicap = Number(el('plHcp').value||0);
    const flight = (el('plFlight').value||'').trim() || (el('gcFlight').value||'').trim() || null;
    const teeTime = el('plTee').value || el('gcTeeTime').value || null;

    if(!name){ alert('Naam is verplicht.'); return; }

    const editingId = el('addPlayerBtn').dataset.editing;
    if(editingId){
      await setDoc(doc(db,'games',gameId,'players', editingId), {
        name, handicap, flight, teeTime, updatedAt: serverTimestamp()
      }, {merge:true});
      el('addPlayerBtn').textContent = 'Speler toevoegen';
      delete el('addPlayerBtn').dataset.editing;
    }else{
      // Als je je eigen player wil koppelen aan je uid, vul exact je inline naam/hcp in en wijzig daarna indien nodig
      await addDoc(collection(db,'games',gameId,'players'), {
        name, handicap, flight, teeTime, createdAt: serverTimestamp()
      });
    }

    el('plName').value=''; el('plHcp').value=0; el('plFlight').value=''; el('plTee').value='';
  };

  /* INIT */
  holesData = blankHoles();
  buildHolesTable(holesData);
  updateHeader(); updateScoreUI();

  // inline naam & hcp edits -> koppelen aan eigen spelerskaart (op uid)
  document.getElementById('playerNameInline').addEventListener('change', async ()=>{
    if(!gameId||!uid) return;
    const name = document.getElementById('playerNameInline').value.trim();
    await setDoc(doc(db,'games',gameId,'players',uid), {name}, {merge:true});
  });
  document.getElementById('playerHcpInline').addEventListener('change', async ()=>{
    if(!gameId||!uid) return;
    const handicap = Number(document.getElementById('playerHcpInline').value||0);
    await setDoc(doc(db,'games',gameId,'players',uid), {handicap}, {merge:true});
  });
  </script>
</body>
</html>
